<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.planner.mapper.VoteMapper">

<insert id="voteInsert" parameterType="VoteDTO">
    INSERT INTO vote(
    	team_board_id,
    	vote_title,
    	vote_content,
    	vote_end
    ) VALUES (
        #{team_board_id},
        #{vote_title},
        #{vote_content},
        #{vote_end}
    )
</insert>

<!-- 투표 시퀀스 찾기 -->
<select id="findVoteId" resultType="Long">
	SELECT vote_id
	FROM vote 
	WHERE team_board_id = #{team_board_id}
</select>

<insert id="voteItemInsert">
	INSERT INTO vote_item (vote_id, vote_item_name) VALUES(
		#{vote_id}, 
		#{vote_item_name}
	)
<!--     <foreach collection="vote_item_names" item="vote_item_name" separator=","> -->
<!--     </foreach> -->
</insert>

<resultMap type="VoteInfoDTO" id="voteInfo">
	<result column="vote_id"		property="vote_id"/>
	<result column="vote_title"		property="vote_title"/>
	<result column="vote_content"	property="vote_content"/>
	<result column="vote_end"		property="vote_end"/>
	<collection column="vote_id" property="vote_items" javaType="List" ofType="VoteItemDTO">
		<id		column="vote_item_id"	property="vote_item_id"></id>
		<result column="vote_item_name"	property="vote_item_name"></result>
		<collection column="vote_item_id" property="vote_members" javaType="List" ofType="Long">
			<id column="team_member_id"></id>
		</collection>
	</collection>
</resultMap>

<select id="voteInfo" resultMap="voteInfo">
	SELECT v.vote_id, v.vote_title, v.vote_content, v.vote_end,
           vi.vote_item_id, vi.vote_item_name,
           vm.team_member_id
    FROM vote v
    JOIN vote_item vi ON v.vote_id = vi.vote_id
    LEFT OUTER JOIN vote_member vm ON vm.vote_item_id = vi.vote_item_id
    WHERE v.vote_id = #{vote_id}
</select>

<select id="voteCheck">
	select count(*)
	from vote_member
	where vote_item_id in
	        (select vote_item_id from vote_item where vote_id = #{vote_id})
		and team_member_id=#{team_member_id}
</select>

<insert id="voteMemberInsert">
	insert into vote_member values(#{vote_item_id}, #{team_member_id})
</insert>

</mapper>